!function(e){function t(s){if(n[s])return n[s].exports;var o=n[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,s){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:s})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=2)}([function(e,t){var n=Vue.component("task-textarea",{template:'<div>    <div class="task-info">残り {{todo_count}}/{{ count }} タスク. {{todo_sizes}}/{{ sizes }} 規模. [{{sepaMode.mode}}]</div>    <div id="editor"></div>  </div>',props:["tasks","line"],data:function(){return{count:0,todo_count:0,doing_count:0,done_count:0,sizes:0,todo_sizes:0,doing_sizes:0,done_sizes:0,text:"",sepaMode:this.judgeSepaMode(""),editor:null,beforeCursor:-1}},watch:{tasks:function(){this.updateTasks()},line:function(){this.editor.gotoLine(this.line,0),this.editor.focus()}},mounted:function(){var e=this;localStorage.text?e.text=localStorage.text:e.text=["タスク1 30 Todo","タスク2 40 Todo","タスク3 50 Todo Cさん","タスク4 60 Todo","タスク5 70 Doing Aさん","タスク6 80 Done","タスク7 55 Todo Aさん","タスク8 45 Doing","タスク9 35 Done Cさん","タスク10 90 Done Bさん"].join("\n"),e.editor=ace.edit("editor"),e.editor.setTheme("ace/theme/chaos"),e.editor.getSession().setUseWrapMode(!0),e.editor.$blockScrolling=1/0,e.editor.session.setOptions({tabSize:2,useSoftTabs:!1}),e.editor.on("change",function(){e.text=e.editor.getValue(),e.updateText()}),e.editor.session.selection.on("changeCursor",function(t){var n=e.editor.selection.getCursor();e.beforeCursor.row!=n.row&&(e.beforeCursor=n,e.updateText())}),e.editor.setValue(e.text,-1)},methods:{getSizes:function(e){return 0==e.length?0:1==e.length?e[0].size:e.map(function(e){return e.size}).reduce(function(e,t){return e+t})},judgeSepaMode:function(e){return e.match(/\t/)?{mode:"tab",delim:"\t",reg:/(.+)[\t]+([\d\.]+)([\t]+(\w+))?([\t]+(.+))?/}:{mode:"space",delim:" ",reg:/(\S+)[ ]+([\d\.]+)([ ]+(\S+))?([ ]+(\S+))?/}},setTaskStatus:function(e){var t=this,n=e.filter(function(e){return null!=e.status&&e.status.match(/Doing/i)}),s=e.filter(function(e){return null!=e.status&&e.status.match(/Done/i)}),o=e.filter(function(e){return null==e.status||!e.status.match(/Done/i)});t.count=e.length,t.todo_count=o.length,t.doing_count=n.length,t.done_count=s.length,t.sizes=t.getSizes(e),t.todo_sizes=t.getSizes(o),t.doing_sizes=t.getSizes(n),t.done_sizes=t.getSizes(s)},updateText:function(){var e=this;localStorage&&(localStorage.text=e.text),e.sepaMode=e.judgeSepaMode(e.text);var t=e.editor.selection.getCursor(),n=e.text.split("\n").map(function(n,s){var o=n.match(e.sepaMode.reg);return null==o?null:{i:s+1,cursor:s==t.row,name:o[1],size:Number(o[2]),status:o[4]?o[4]:"Todo",assignee:o[6]}}).filter(function(e){return null!=e});e.setTaskStatus(n),e.$emit("update-tasks",{tasks:{children:n}})},updateTasks:function(){var e=this,t=e.sepaMode.delim,n=e.tasks.children,s=[],o=-1;n.forEach(function(e,n){s.push(e.name+t+e.size+t+e.status+t+(e.assignee?e.assignee:"")),e.cursor&&(o=n+1)}),e.text=s.join("\n"),e.editor.setValue(e.text,-1),e.editor.gotoLine(o,0),e.editor.focus()}}});e.exports=n},function(e,t){var n=Vue.component("task-treemap",{template:'<div>    <div class="task-info">      残り規模       <span class="user-info" v-for="user in users" draggable="true" @dragstart="dragstart(user, $event)" @dragend="dragend">        <span v-bind:class="user.class">{{user.name}} {{user.todo_sizes}}/{{user.sizes}}</span>      </span>    </div>    <div id="treemap"></div>  </div>',props:["tasks"],data:function(){return{ColorMax:9,users:[],draggingItem:null}},watch:{tasks:function(){this.setTasks()}},methods:{setTasks:function(){this.update()},getColorNo:function(e){var t=this;return 0==e?0:e%t.ColorMax+1},getStatusColor:function(e){var t="rgb(152, 223, 138)";return null==e?t:e.match(/Done/i)?"rgb(199, 199, 199)":e.match(/Doing/i)?"rgb(174, 199, 232)":t},getSizes:function(e){return 0==e.length?0:1==e.length?e[0].size:e.map(function(e){return e.size}).reduce(function(e,t){return e+t})},update:function(){var e=this;if(e.users=[],null!=e.tasks&&null!=e.tasks.children){var t=e.tasks.children,n={"":{id:0,children:[]}},s=0;t.forEach(function(e){var t=null!=e.assignee?e.assignee:"";null==n[t]?n[t]={id:++s,children:[e]}:n[t].children.push(e)});var o={name:"root_dir",children:Object.keys(n).map(function(e){return{name:e,children:n[e].children}})};e.users=o.children.map(function(t){return{name:t.name,class:"assignee-list-elem task-assignee assignee-"+e.getColorNo(n[t.name].id),sizes:e.getSizes(t.children),todo_sizes:e.getSizes(t.children.filter(function(e){return null==e.status||!e.status.match(/Done/i)}))}});var i=document.getElementById("treemap").clientHeight,r=document.getElementById("treemap").clientWidth,a=d3.layout.treemap().size([r,i]).value(function(e){return e.size});if(d3.select("#treemap").selectAll("div").remove(),0!=t.length){var u=d3.select("#treemap").selectAll("div").data(a.nodes(o));u.enter().append("div").on("click",function(t){e.$emit("select-task",{no:t.i})}).on("dragover",function(e){d3.event.preventDefault()}).on("drop",function(n){t.forEach(function(e){e.cursor=!1}),n.assignee=e.draggingItem.name,n.cursor=!0;var s={children:null};s.children=t,e.$emit("update-tasks",{tasks:s})}),u.exit().remove(),d3.select("#treemap").selectAll("div").style("left",function(e){return e.x+"px"}).style("top",function(e){return e.y+"px"}).style("width",function(e){return e.dx-2+"px"}).style("height",function(e){return e.dy-2+"px"}).style("background",function(t,n){return e.getStatusColor(t.status)}).style("position","absolute").style("overflow","hidden").style("border",function(e){return e.cursor?"solid 1px red":"solid 1px #333"}).style("font-weight",function(e){return e.cursor?"bold":"normal"}).style("color",function(e){return e.cursor?"firebrick":"black"}).style("padding","0px").style("left",function(e){return e.x+"px"}).html(function(t){return t.children?"":[t.assignee?'<div><span class="task-assignee assignee-'+e.getColorNo(n[t.assignee].id)+'">'+t.assignee+"</span></div>":"",'<div class="task-name">'+t.name+"</div>",'<div class="task-size">'+t.size+"</div>"].join("")})}}},dragstart:function(e,t){this.draggingItem=e,t.target.style.opacity=.5},dragend:function(e){e.target.style.opacity=1}}});e.exports=n},function(e,t,n){n(1),n(0);new Vue({el:"#app",data:{tasks:null,textTasks:null,taskLine:0},methods:{updateTasks:function(e){this.tasks=e.tasks},updateTextTasks:function(e){this.textTasks=e.tasks,this.taskLine=e.tasks.children.filter(function(e){return 1==e.cursor})[0].i},selectTask:function(e){this.taskLine=e.no}}})}]);